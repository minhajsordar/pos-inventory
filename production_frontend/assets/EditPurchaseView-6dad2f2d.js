import{af as Pe,u as Ne,g as r,f as ce,E as de,ac as Ve,o as p,c as X,w as h,b as a,a as u,au as B,d as Z,Q as O,e as y,ag as pe,ah as me,ak as i,n as G,ai as M,h as W,aj as P,ax as D,j as Se,R as qe}from"./index-b55a7827.js";import{Q as he}from"./QMarkupTable-1fc170d9.js";import{Q as I}from"./QSelect-c33eb5ef.js";import{Q as Ce}from"./QPage-615bd1f9.js";import{u as Le,a as U}from"./use-quasar-96558313.js";import{u as Te,g as E}from"./userAuthStore-0c477450.js";import"./QChip-1b4874fe.js";import"./QItemLabel-82cf5c84.js";import"./selection-af93f90a.js";import"./rtl-36dd996b.js";import"./format-6ceb96d6.js";const Be=a("div",{class:"p-0 text-h5 mb-2"}," Edit purchase ",-1),Oe={class:"flex flex-wrap -m-1"},De={class:"w-3/5 p-1"},Ue={class:"flex justify-between"},Ee=a("div",null,"Payment List",-1),Qe=a("thead",null,[a("tr",{class:"bg-grey-3"},[a("th",{class:"text-left"},"Bank Account"),a("th",{class:"text-right"},"Payment Type"),a("th",{class:"text-right"},"Amount"),a("th",{class:"text-right"},"Time"),a("th",{class:"text-right"},"Action")])],-1),Fe={class:"text-left"},ze={class:"text-right"},Je={class:"text-right"},Re={class:"text-right"},$e={class:"text-right"},je=a("td",{class:"text-right",colspan:"2"},[a("span",{class:"text-h6"},"Due")],-1),Ge={class:"text-right",colspan:"1"},Me={class:"text-h6"},We=a("td",{class:"text-left",colspan:"2"},null,-1),Ie={class:"flex justify-between"},He=a("div",null,"Product List",-1),Ye=a("thead",null,[a("tr",{class:"bg-grey-3"},[a("th",{class:"text-left"},"Name"),a("th",{class:"text-right"},"Purchase Rate"),a("th",{class:"text-right"},"Quantity"),a("th",{class:"text-right"},"Total Price"),a("th",{class:"text-right"},"Selling Rate"),a("th",{class:"text-right"},"Action")])],-1),Ke={class:"text-left"},Xe={class:"text-right"},Ze={class:"text-right"},et={class:"text-right"},tt={class:"text-right"},at={class:"text-right"},ot=a("td",{class:"text-right",colspan:"3"},[a("span",{class:"text-h6"},"Sub Total")],-1),st={class:"text-right"},lt={class:"text-h6"},nt=a("td",{class:"text-left",colspan:"2"},null,-1),ut={class:"w-2/5 p-1"},rt=a("div",null,"Add/Edit Product",-1),it={key:0,class:"text-red-8 text-xs q-pl-sm mb-6"},ct={class:"mb-6"},dt={key:0,class:"text-red-8 text-xs q-pl-sm"},pt={class:"mb-6"},mt={key:0,class:"text-red-8 text-xs q-pl-sm"},ht={class:"mb-6"},vt={key:0,class:"text-red-8 text-xs q-pl-sm"},gt={class:"mb-6"},yt={class:"mb-6"},ft={key:0,class:"text-red-8 text-xs q-pl-sm"},_t=a("div",null,"Total",-1),bt={class:"mb-6"},kt={key:0,class:"text-red-8 text-xs q-pl-sm"},xt={class:"mb-6"},wt={key:0,class:"text-red-8 text-xs q-pl-sm"},At={class:"mb-6"},Pt={key:0,class:"text-red-8 text-xs q-pl-sm"},Nt={class:"mb-6"},Vt={class:"mb-6"},St={key:0,class:"mb-6"},qt={key:0,class:"text-red-8 text-xs q-pl-sm"},Ct={class:"flex -m-1"},Lt={class:"p-1"},Tt={class:"p-1"},Gt={__name:"EditPurchaseView",setup(Bt){const s=Le();Te();const x=Pe(),ee=Ne(),te=r([]),H=r([]),c=r([]),ve=r([]),N=r([]),ae=r([]),w=r(null),q=r(1),C=r(1),Q=r(1),F=r(1),_=r({}),v=r({}),z=r(null),b=r(0),V=r(0),Y=r(0),J=r(null),$=r("Bank"),j=r(!1),L=r(null),oe=ce({supplier:"",amount:"",paidAmount:"",duePaidList:"",quantity:"",unit:"",bankAccount:""}),R=ce({supplier:"",amount:"",paidAmount:0,duePaidList:"",quantity:"",unit:"",bankAccount:""}),se=()=>{F.value=q.value*C.value},ge=()=>{var o,n,m;const l={};if(w.value||(l.product="Required Field. Select a product"),q.value||(l.price="Required Field. Must be greater than 0."),C.value||(l.quantity="Required Field. Must be greater than 0."),Q.value||(l.sellingPrice="Required Field. Must be greater than purchase rate."),L.value==null&&c.value.some(A=>{var k;return A.product===((k=w.value)==null?void 0:k._id)})&&(l.product="Product Already Added. To add again remove from below list."),Object.keys(l).length>0){_.value=l;return}const t={product:(o=w.value)==null?void 0:o._id,name:(n=w.value)==null?void 0:n.name,price:q.value,quantity:C.value,unit:(m=w.value)==null?void 0:m.unit,total:F.value,sellingPrice:Q.value},e=[...JSON.parse(JSON.stringify(c.value))];L.value!==null?e[L.value]={...e[L.value],...t}:e.push(t),_.value={},w.value=null,q.value=1,C.value=1,F.value=1,Q.value=1,s.dialog({title:"Confirm",message:"Would you like to add new product to this purchase?",ok:{push:!0},cancel:{push:!0,color:"negative"},persistent:!0}).onOk(()=>{ie(e),L.value=null}).onCancel(()=>{}).onDismiss(()=>{})},ye=l=>{const t=JSON.parse(JSON.stringify(c.value));t.splice(l,1),s.dialog({title:"Confirm",message:"Would you like to add new product to this purchase?",ok:{push:!0},cancel:{push:!0,color:"negative"},persistent:!0}).onOk(()=>{ie(t)}).onCancel(()=>{}).onDismiss(()=>{})},fe=l=>{s.dialog({title:"Confirm",message:"Would you like to delete this payment?",ok:{push:!0},cancel:{push:!0,color:"negative"},persistent:!0}).onOk(()=>{const t=JSON.parse(JSON.stringify(N.value));t.splice(l,1),Ae(t)}).onCancel(()=>{}).onDismiss(()=>{})},_e=l=>{H.value.forEach((t,e)=>{t._id==c.value[l].product&&(t.value=t._id,t.label=t.name,w.value=t,L.value=l,j.value=!0,q.value=c.value[l].price,Q.value=c.value[l].sellingPrice,C.value=c.value[l].quantity,F.value=c.value[l].total)})},be=()=>{L.value=null,j.value=!1},ke=()=>{L.value=null,j.value=!0,w.value=null,q.value=1,C.value=1,F.value=1,Q.value=1};de([c,N],()=>{console.log("updating"),b.value=c.value.reduce((l,t)=>Number(l)+Number(t.total),0)-N.value.reduce((l,t)=>Number(l)+Number(t.amount),0)}),de([b,V,c,N],()=>{Y.value=b.value-V.value});const K=async()=>{var t;if(x.params.id=="create"){le(),ue(),re(),ne();return}const l={method:"GET",url:"api/purchase/purchase_lists/"+x.params.id,headers:{Authorization:`Bearer ${E("token")}`}};try{s.loading.show();const e=await U.request(l);s.loading.hide(),z.value=e.data.supplier,c.value=e.data.products,R.supplier=e.data.supplier,b.value=e.data.amount,R.amount=e.data.amount,V.value=Number(e.data.amount)-Number(e.data.paidAmount),R.paidAmount=e.data.paidAmount,N.value=e.data.paymentDetails,R.duePaidList=e.data.duePaidList,J.value=e.data.bankAccount,R.bankAccount=e.data.bankAccount}catch(e){((t=e==null?void 0:e.response)==null?void 0:t.status)==401?s.notify({message:e.response.data.message+". Login to try again.",color:"red",position:"top",actions:[{icon:"close",color:"white",handler:()=>{}}]}):s.notify({message:e.message,color:"red",position:"top",actions:[{icon:"close",color:"white",handler:()=>{}}]}),s.loading.hide(),console.error(e)}finally{le(),ue(),re(),ne()}};Ve(()=>{K()});const le=async()=>{var t;const l={method:"GET",url:"api/supplier/supplier_lists",headers:{Authorization:`Bearer ${E("token")}`}};try{s.loading.show();const e=await U.request(l);te.value=e.data.suppliers.map(o=>(o.label=o.companyName,o.value=o._id,z.value===o._id&&(z.value=o),o)),s.loading.hide()}catch(e){((t=e==null?void 0:e.response)==null?void 0:t.status)==401?s.notify({message:e.response.data.message+". Login to try again.",color:"red",position:"top",actions:[{icon:"close",color:"white",handler:()=>{}}]}):s.notify({message:e.message,color:"red",position:"top",actions:[{icon:"close",color:"white",handler:()=>{}}]}),s.loading.hide(),console.error(e)}},ne=async()=>{var t;const l={method:"GET",url:"api/product/product_lists",headers:{Authorization:`Bearer ${E("token")}`}};try{s.loading.show();const e=await U.request(l);H.value=e.data.products.map(o=>(o.label=o.name,o.value=o._id,o)),s.loading.hide()}catch(e){((t=e==null?void 0:e.response)==null?void 0:t.status)==401?s.notify({message:e.response.data.message+". Login to try again.",color:"red",position:"top",actions:[{icon:"close",color:"white",handler:()=>{}}]}):s.notify({message:e.message,color:"red",position:"top",actions:[{icon:"close",color:"white",handler:()=>{}}]}),s.loading.hide(),console.error(e)}},ue=async()=>{var t;const l={method:"GET",url:"api/unit/unit_lists",headers:{Authorization:`Bearer ${E("token")}`}};try{s.loading.show();const e=await U.request(l);ve.value=e.data.units.map(o=>(o.label=o.value,o.value=o._id,oe.unit===o._id&&(oe.unit=o),o)),s.loading.hide()}catch(e){((t=e==null?void 0:e.response)==null?void 0:t.status)==401?s.notify({message:e.response.data.message+". Login to try again.",color:"red",position:"top",actions:[{icon:"close",color:"white",handler:()=>{}}]}):s.notify({message:e.message,color:"red",position:"top",actions:[{icon:"close",color:"white",handler:()=>{}}]}),s.loading.hide(),console.error(e)}},re=async()=>{var t;const l={method:"GET",url:"api/bank_account/bank_account_lists",headers:{Authorization:`Bearer ${E("token")}`}};try{s.loading.show();const e=await U.request(l);ae.value=e.data.bankAccounts.map(o=>(o.label=o.name,o.value=o._id,J.value===o._id&&(J.value=o),o)),s.loading.hide()}catch(e){((t=e==null?void 0:e.response)==null?void 0:t.status)==401?s.notify({message:e.response.data.message+". Login to try again.",color:"red",position:"top",actions:[{icon:"close",color:"white",handler:()=>{}}]}):s.notify({message:e.message,color:"red",position:"top",actions:[{icon:"close",color:"white",handler:()=>{}}]}),s.loading.hide(),console.error(e)}},xe=()=>{V.value=Number(b.value)},we=async l=>{var n,m,S,A,k,T,d;l.preventDefault(),v.value={};const t={};(n=z.value)!=null&&n._id?t.supplier=(m=z.value)==null?void 0:m._id:v.value.supplier="Please Select A Supplier.",b.value||(v.value.amount="You don't have any due amount"),Number(b.value)<Number(V.value)&&(v.value.payAmount="Amount can't be greater than due amount"),t.paidAmount=Number(V.value)+Number(N.value.reduce((g,f)=>Number(g)+Number(f.amount),0)),$.value=="Bank"&&!((S=J.value)!=null&&S._id)&&(v.value.bankAccount="Please Select Bank Account.");const e={amount:V.value,type:$.value,bankAccount:(A=J.value)==null?void 0:A._id,time:new Date};if(t.paymentDetails=JSON.stringify([...JSON.parse(JSON.stringify(N.value)),e]),t.products=JSON.stringify(c.value),t.amount=c.value.reduce((g,f)=>Number(g)+Number(f.total),0),Object.keys(v.value).length!==0)return;if(console.log(t),Object.keys(t).length<=0){s.notify({message:"Empty Form Submission Not Allowed",color:"red",position:"top",actions:[{icon:"close",color:"white",handler:()=>{}}]});return}const o={headers:{"Content-Type":"multipart/form-data",Authorization:`Bearer ${E("token")}`},data:t};x.params.id=="create"?(o.method="post",o.url="api/purchase/purchase_lists"):(o.method="put",o.url="api/purchase/purchase_lists/"+x.params.id);try{const g=await U.request(o);(k=x.query)!=null&&k.redirect?ee.push(`/${(T=x.query)==null?void 0:T.redirect}`):ee.push("/dashboard/purchase/purchase_list"),s.notify({message:"Updated Successfully!",color:"primary",position:"top",actions:[{icon:"close",color:"white",handler:()=>{}}]})}catch(g){((d=g==null?void 0:g.response)==null?void 0:d.status)==401?s.notify({message:g.response.data.message+". Login to try again.",color:"red",position:"top",actions:[{icon:"close",color:"white",handler:()=>{}}]}):s.notify({message:g.message,color:"red",position:"top",actions:[{icon:"close",color:"white",handler:()=>{}}]}),console.error(g)}},Ae=async l=>{var o;const t={};if(t.paidAmount=Number(l.reduce((n,m)=>Number(n)+Number(m.amount),0)),t.paymentDetails=JSON.stringify(l),Object.keys(t).length<=0){s.notify({message:"Empty Form Submission Not Allowed",color:"red",position:"top",actions:[{icon:"close",color:"white",handler:()=>{}}]});return}const e={headers:{"Content-Type":"multipart/form-data",Authorization:`Bearer ${E("token")}`},data:t};x.params.id=="create"?(e.method="post",e.url="api/purchase/purchase_lists"):(e.method="put",e.url="api/purchase/purchase_lists/"+x.params.id);try{const n=await U.request(e);s.notify({message:"Updated Successfully!",color:"primary",position:"top",actions:[{icon:"close",color:"white",handler:()=>{}}]})}catch(n){((o=n==null?void 0:n.response)==null?void 0:o.status)==401?s.notify({message:n.response.data.message+". Login to try again.",color:"red",position:"top",actions:[{icon:"close",color:"white",handler:()=>{}}]}):s.notify({message:n.message,color:"red",position:"top",actions:[{icon:"close",color:"white",handler:()=>{}}]}),console.error(n)}finally{await K()}},ie=async l=>{var o;const t={};if(t.products=JSON.stringify(l),t.amount=l.reduce((n,m)=>Number(n)+Number(m.total),0),Object.keys(t).length<=0){s.notify({message:"Empty Form Submission Not Allowed",color:"red",position:"top",actions:[{icon:"close",color:"white",handler:()=>{}}]});return}const e={headers:{"Content-Type":"multipart/form-data",Authorization:`Bearer ${E("token")}`},data:t};x.params.id=="create"?(e.method="post",e.url="api/purchase/purchase_lists"):(e.method="put",e.url="api/purchase/purchase_lists/"+x.params.id);try{const n=await U.request(e);s.notify({message:"Updated Successfully!",color:"primary",position:"top",actions:[{icon:"close",color:"white",handler:()=>{}}]})}catch(n){((o=n==null?void 0:n.response)==null?void 0:o.status)==401?s.notify({message:n.response.data.message+". Login to try again.",color:"red",position:"top",actions:[{icon:"close",color:"white",handler:()=>{}}]}):s.notify({message:n.message,color:"red",position:"top",actions:[{icon:"close",color:"white",handler:()=>{}}]}),console.error(n)}finally{await K()}};return(l,t)=>(p(),X(Ce,{padding:""},{default:h(()=>[Be,a("div",Oe,[a("div",De,[u(W,{flat:"",bordered:"",class:G(["my-card mb-2",M(s).dark.isActive?"bg-grey-9":"bg-grey-2"])},{default:h(()=>[u(B,{class:"q-pb-none text-h6"},{default:h(()=>[a("div",Ue,[Ee,Z(),u(O,{onClick:be,label:"Add Payment",color:"orange"})])]),_:1}),u(B,null,{default:h(()=>[a("div",null,[u(he,{separator:"cell",flat:"",bordered:""},{default:h(()=>[Qe,a("tbody",null,[(p(!0),y(me,null,pe(N.value,(e,o)=>(p(),y("tr",null,[a("td",Fe,i(e==null?void 0:e.bankAccount),1),a("td",ze,i(e==null?void 0:e.type),1),a("td",Je,i(e==null?void 0:e.amount),1),a("td",Re,i(e==null?void 0:e.time),1),a("td",$e,[u(O,{icon:"delete",color:"red",flat:"",dense:"",size:"md",onClick:()=>fe(o)},null,8,["onClick"])])]))),256)),a("tr",null,[je,a("td",Ge,[a("span",Me,i(Number(R.amount)-N.value.reduce((e,o)=>Number(e)+Number(o.amount),0)),1)]),We])])]),_:1})])]),_:1})]),_:1},8,["class"]),u(W,{flat:"",bordered:"",class:G(["my-card",M(s).dark.isActive?"bg-grey-9":"bg-grey-2"])},{default:h(()=>[u(B,{class:"q-pb-none text-h6"},{default:h(()=>[a("div",Ie,[He,Z(),u(O,{onClick:ke,label:"Add Product",color:"orange"})])]),_:1}),u(B,null,{default:h(()=>[a("div",null,[u(he,{separator:"cell",flat:"",bordered:""},{default:h(()=>[Ye,a("tbody",null,[(p(!0),y(me,null,pe(c.value,(e,o)=>(p(),y("tr",null,[a("td",Ke,[Z(i(e==null?void 0:e.name)+" ",1),u(D,{"model-value":c.value[o].name,"onUpdate:modelValue":n=>c.value[o].name=n,flat:"",borderless:""},null,8,["model-value","onUpdate:modelValue"])]),a("td",Xe,i(e==null?void 0:e.price),1),a("td",Ze,i(e==null?void 0:e.quantity),1),a("td",et,i(e==null?void 0:e.total),1),a("td",tt,i(e==null?void 0:e.sellingPrice),1),a("td",at,[u(O,{icon:"edit",color:"green",flat:"",dense:"",size:"md",onClick:()=>_e(o)},null,8,["onClick"]),u(O,{icon:"delete",color:"red",flat:"",dense:"",size:"md",onClick:()=>ye(o)},null,8,["onClick"])])]))),256)),a("tr",null,[ot,a("td",st,[a("span",lt,i(c.value.reduce((e,o)=>Number(e)+Number(o.total),0)),1)]),nt])])]),_:1})])]),_:1})]),_:1},8,["class"])]),a("div",ut,[j.value?(p(),X(W,{key:0,flat:"",bordered:"",class:G(["my-card mb-2",M(s).dark.isActive?"bg-grey-9":"bg-grey-2"])},{default:h(()=>[u(B,{class:"q-pb-none text-h6"},{default:h(()=>[rt]),_:1}),u(B,null,{default:h(()=>{var e,o,n,m,S,A,k,T,d,g;return[a("div",null,[(e=_.value)!=null&&e.headerWarning?(p(),y("div",it,[a("span",null,i((o=_.value)==null?void 0:o.headerWarning),1)])):P("",!0),a("div",ct,[u(I,{label:"Select an option for product ",placeholder:"Value",modelValue:w.value,"onUpdate:modelValue":t[0]||(t[0]=f=>w.value=f),options:H.value,outlined:"",dense:""},null,8,["modelValue","options"]),(n=_.value)!=null&&n.product?(p(),y("div",dt,[a("span",null,i((m=_.value)==null?void 0:m.product),1)])):P("",!0)]),a("div",pt,[u(D,{label:"Purchase Rate *",type:"number",placeholder:"Purchase Rate",modelValue:q.value,"onUpdate:modelValue":[t[1]||(t[1]=f=>q.value=f),se],outlined:"",dense:""},null,8,["modelValue"]),(S=_.value)!=null&&S.price?(p(),y("div",mt,[a("span",null,i((A=_.value)==null?void 0:A.price),1)])):P("",!0)]),a("div",ht,[u(D,{label:"Quantity *",type:"number",placeholder:"Quantity",modelValue:C.value,"onUpdate:modelValue":[t[2]||(t[2]=f=>C.value=f),se],outlined:"",dense:""},null,8,["modelValue"]),(k=_.value)!=null&&k.quantity?(p(),y("div",vt,[a("span",null,i((T=_.value)==null?void 0:T.quantity),1)])):P("",!0)]),a("div",gt,[u(D,{label:"Total *",type:"number",placeholder:"Total",modelValue:F.value,"onUpdate:modelValue":t[3]||(t[3]=f=>F.value=f),outlined:"",disable:"",dense:""},null,8,["modelValue"])]),a("div",yt,[u(D,{label:"Selling Rate *",type:"number",placeholder:"Selling",modelValue:Q.value,"onUpdate:modelValue":t[4]||(t[4]=f=>Q.value=f),outlined:"",dense:""},null,8,["modelValue"]),(d=_.value)!=null&&d.sellingPrice?(p(),y("div",ft,[a("span",null,i((g=_.value)==null?void 0:g.sellingPrice),1)])):P("",!0)]),u(O,{label:"Add To Cart",color:"green",onClick:ge})])]}),_:1})]),_:1},8,["class"])):(p(),X(W,{key:1,flat:"",bordered:"",class:G(["my-card",[M(s).dark.isActive?"bg-grey-9":"bg-grey-2",b.value==0?"opacity-60 pointer-events-none":""]])},{default:h(()=>[u(B,{class:"q-pb-none text-h6"},{default:h(()=>[_t]),_:1}),u(B,null,{default:h(()=>{var e,o,n,m,S,A,k,T;return[a("div",null,[a("div",bt,[u(I,{label:"Select an option for Supplier ",placeholder:"Value",modelValue:z.value,"onUpdate:modelValue":t[5]||(t[5]=d=>z.value=d),options:te.value,outlined:"",dense:""},null,8,["modelValue","options"]),(e=v.value)!=null&&e.supplier?(p(),y("div",kt,[a("span",null,i((o=v.value)==null?void 0:o.supplier),1)])):P("",!0)]),a("div",xt,[u(D,{label:"Amount *",type:"number",placeholder:"Amount",modelValue:b.value,"onUpdate:modelValue":t[6]||(t[6]=d=>b.value=d),outlined:"",dense:"",disable:""},null,8,["modelValue"]),(n=v.value)!=null&&n.amount?(p(),y("div",wt,[a("span",null,i((m=v.value)==null?void 0:m.amount),1)])):P("",!0)]),a("div",At,[u(D,{label:"Pay amount *",type:"number",placeholder:"Paid amount",modelValue:V.value,"onUpdate:modelValue":t[7]||(t[7]=d=>V.value=d),outlined:"",dense:""},null,8,["modelValue"]),(S=v.value)!=null&&S.payAmount?(p(),y("div",Pt,[a("span",null,i((A=v.value)==null?void 0:A.payAmount),1)])):P("",!0)]),a("div",Nt,[u(D,{label:"Due ",type:"text",placeholder:"Due",modelValue:Y.value,"onUpdate:modelValue":t[8]||(t[8]=d=>Y.value=d),outlined:"",dense:"",disable:""},null,8,["modelValue"])]),a("div",Vt,[u(I,{label:"Payment Type ",options:["Bank","Cash"],placeholder:"Due",modelValue:$.value,"onUpdate:modelValue":t[9]||(t[9]=d=>$.value=d),outlined:"",dense:""},null,8,["modelValue"])]),$.value=="Bank"?(p(),y("div",St,[u(I,{label:"Select an option for Bank account ",placeholder:"Value",modelValue:J.value,"onUpdate:modelValue":t[10]||(t[10]=d=>J.value=d),options:ae.value,outlined:"",dense:""},null,8,["modelValue","options"]),(k=v.value)!=null&&k.bankAccount?(p(),y("div",qt,[a("span",null,i((T=v.value)==null?void 0:T.bankAccount),1)])):P("",!0)])):P("",!0),Se(a("div",Ct,[a("div",Lt,[u(O,{label:"Full Payment",color:"cyan",onClick:xe})]),a("div",Tt,[u(O,{label:l.$route.params.id==="create"?"Create Purchase":"Update Purchase",color:"green",onClick:we},null,8,["label"])])],512),[[qe,b.value!==0]])])]}),_:1})]),_:1},8,["class"]))])])]),_:1}))}};export{Gt as default};
